---
title: "Introduction to the landmarkR package"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{intro-landmarkR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(tidyverse)
library(landmarkR)
```

# Setup

In this vignette, we use the `epileptic` dataset provided alongside `landmarkR`
to perform landmarking analysis of time-to-event data with time-varying
covariates. This is the structure of the data:

```{r}
data("epileptic")
str(epileptic)
```

The dataset contains the following variables:

-   id: a unique patient identifier

-   time: time when time-varying covariate "dose" was recorded

-   with.time: time when the first of event or censoring happened

-   with.status: indicates whether event (1) or censoring (0) occurred

-   dose: a time-varying covariate

-   treat, age, gender, learn.dis: static (baseline) covariates

The first step is to split the dataset into two, one dataset describing static
covariates, event time and indicator of event/censoring, and another dataset
describing dynamic covariates.

```{r}
# DF with Static covariates
df_static <- epileptic |>
  select(id, with.time, with.status, treat, age, gender, learn.dis) |>
  rename(patient.id = id, event.time = with.time, event.status = with.status) |>
  unique()

head(df_static)
```

```{r}
# DF with Dynamic covariates
df_dynamic <- epileptic |>
  select(id, time, dose) |>
  mutate(covariate = "dose") |>
  rename(patient.id = id, measurement = dose, measurement_time = time)
head(df_dynamic)
```

# Create Landmarking object

The next step is to create an object of class `Landmarking` by using the helper
function of the same name.

```{r}
landmarking_object <- Landmarking(
  data_static = df_static,
  data_dynamic = df_dynamic,
  event_indicator = "event.status",
  dynamic_covariates = "dose",
  ids = "patient.id",
  event_time = "event.time"
)
```

Arguments for the helper function are defined as follows:

- data_static and data_dynamic: the two datasets we just created.

- event_indicator: name of the column that indicates the censoring indicator
  in the static dataset.

- dynamic_covariates: array column names in the dynamic dataset indicating
  time-varying covariates.

- ids: name of the column that identifies patients in both datasets.

- event_time: name of the column that identifies time of event/censoring in the
  static dataset.

# Baseline survival analysis (without time-varying covariates)

First, we perform a survival without time-varying covariates. We can then use
this as a baseline to evaluate the performance of a subsequent landmark analysis
with such covariates. We first establish the landmark times, and then calculate
the risk sets for each of the provided landmark times using the
`compute_risk_sets()` function. In this instance, we will consider landmarks set
at yearly intervals across five years.

```{r}
landmarks <- seq(from = 365.25, by = 365.25, length.out = 5)

landmarking_object <- landmarking_object |>
  compute_risk_sets(landmarks)

landmarking_object
```

Now we call the `fit_survival()` function to fit the survival models. We set 
horizons to be one year after each landmark time, corresponding to the next
landmark time. For the survival sub-models, we will use Cox proportional hazards
models and will therefore specify the `coxph` method.

```{r}
horizons <- 365.25 + landmarks
method <- "coxph"
dynamic_covariates <- c()

landmarking_object <- landmarking_object |>
  fit_survival(landmarks, horizons, method, dynamic_covariates)

landmarking_object@survival_fits
```

# Landmarking analysis with lme4 + coxph

Now we use the `lme4` package  to fit a linear mixed model to the time-varying
covariate, dose. This first step is followed by fitting Cox PH sub-models using
the longitudinal predictions as covariates.

```{r}
landmarking_object <- Landmarking(
  data_static = df_static,
  data_dynamic = df_dynamic,
  event_indicator = "event.status",
  dynamic_covariates = "dose",
  ids = "patient.id",
  event_time = "event.time"
)

landmarks <- seq(from = 365.25, by = 365.25, length.out = 5)

landmarking_object <- landmarking_object |>
  compute_risk_sets(landmarks)

horizons <- 365.25 + landmarks
method <- "coxph"
dynamic_covariates <- c("dose")

landmarking_object <- landmarking_object |>
  compute_risk_sets(landmarks) |>
  fit_longitudinal(landmarks, "lme4", c("treat", "age", "gender", "learn.dis")) |>
  predict_longitudinal(landmarks, "lme4", c("treat", "age", "gender", "learn.dis")) |>
  fit_survival(landmarks, horizons, method, dynamic_covariates)

landmarking_object@survival_fits
```

# Landmarking analysis with lcmm + coxph

Now we use the `lcmm` package  to fit a latent class mixed model of the
time-varying covariate, dose. This first step is followed by fitting a Cox PH
sub-model using longitudinal predictions as covariates.

```{r}

landmarking_object <- Landmarking(
  data_static = df_static,
  data_dynamic = df_dynamic,
  event_indicator = "event.status",
  dynamic_covariates = "dose",
  ids = "patient.id",
  event_time = "event.time"
)

landmarking_object <- landmarking_object |>
  compute_risk_sets(landmarks) |>
  fit_longitudinal(landmarks, "lcmm", c("treat", "age", "gender", "learn.dis"),
                   ng = 2, mixture = ~treat+age+gender+learn.dis) |>
  predict_longitudinal(landmarks, "lcmm", c("treat", "age", "gender", "learn.dis")) |>
  fit_survival(landmarks, horizons, method, dynamic_covariates)

landmarking_object@survival_fits
```
